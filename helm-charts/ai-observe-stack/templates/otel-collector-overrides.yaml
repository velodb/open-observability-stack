{{/*
OpenTelemetry Collector Gateway - StatefulSet for HA with log persistence
*/}}
{{- if .Values.otel.enabled }}
---
# Headless Service for StatefulSet (required for stable network identity)
apiVersion: v1
kind: Service
metadata:
  name: {{ include "aiobs.otel.fullname" . }}-headless
  labels:
    {{- include "aiobs.labels" . | nindent 4 }}
    app.kubernetes.io/component: otel-collector
spec:
  type: ClusterIP
  clusterIP: None  # Headless service
  ports:
    - name: otlp-grpc
      port: {{ .Values.otel.ports.otlpGrpc }}
      targetPort: {{ .Values.otel.ports.otlpGrpc }}
      protocol: TCP
    - name: otlp-http
      port: {{ .Values.otel.ports.otlpHttp }}
      targetPort: {{ .Values.otel.ports.otlpHttp }}
      protocol: TCP
    - name: metrics
      port: {{ .Values.otel.ports.metrics }}
      targetPort: {{ .Values.otel.ports.metrics }}
      protocol: TCP
    - name: health-check
      port: {{ .Values.otel.ports.healthCheck }}
      targetPort: {{ .Values.otel.ports.healthCheck }}
      protocol: TCP
  selector:
    app.kubernetes.io/name: {{ include "aiobs.name" . }}-otel-collector
    app.kubernetes.io/instance: {{ .Release.Name }}

---
# ClusterIP Service for load balancing across all OTel Collector pods
apiVersion: v1
kind: Service
metadata:
  name: {{ include "aiobs.otel.fullname" . }}
  labels:
    {{- include "aiobs.labels" . | nindent 4 }}
    app.kubernetes.io/component: otel-collector
spec:
  type: ClusterIP
  ports:
    - name: otlp-grpc
      port: {{ .Values.otel.ports.otlpGrpc }}
      targetPort: {{ .Values.otel.ports.otlpGrpc }}
      protocol: TCP
    - name: otlp-http
      port: {{ .Values.otel.ports.otlpHttp }}
      targetPort: {{ .Values.otel.ports.otlpHttp }}
      protocol: TCP
    - name: metrics
      port: {{ .Values.otel.ports.metrics }}
      targetPort: {{ .Values.otel.ports.metrics }}
      protocol: TCP
    - name: health-check
      port: {{ .Values.otel.ports.healthCheck }}
      targetPort: {{ .Values.otel.ports.healthCheck }}
      protocol: TCP
  selector:
    app.kubernetes.io/name: {{ include "aiobs.name" . }}-otel-collector
    app.kubernetes.io/instance: {{ .Release.Name }}

---
# StatefulSet for OTel Collector Gateway (HA with log persistence)
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: {{ include "aiobs.otel.fullname" . }}
  labels:
    {{- include "aiobs.labels" . | nindent 4 }}
    app.kubernetes.io/component: otel-collector
spec:
  serviceName: {{ include "aiobs.otel.fullname" . }}-headless
  replicas: {{ .Values.otel.replicas }}
  podManagementPolicy: {{ .Values.otel.podManagementPolicy | default "Parallel" }}
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ include "aiobs.name" . }}-otel-collector
      app.kubernetes.io/instance: {{ .Release.Name }}
  template:
    metadata:
      labels:
        app.kubernetes.io/name: {{ include "aiobs.name" . }}-otel-collector
        app.kubernetes.io/instance: {{ .Release.Name }}
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/configmap-otel.yaml") . | sha256sum }}
    spec:
      {{- if eq .Values.doris.mode "internal" }}
      initContainers:
        # Wait for Doris to be ready before starting
        - name: wait-for-doris
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for Doris FE MySQL port (9030) to be ready..."
              until nc -z {{ include "aiobs.doris.clusterName" . }}-fe-service 9030; do
                echo "Doris FE MySQL port not ready, waiting..."
                sleep 5
              done
              echo "Doris FE MySQL port is ready!"
              echo "Waiting for Doris FE HTTP port (8030) to be ready..."
              until nc -z {{ include "aiobs.doris.clusterName" . }}-fe-service 8030; do
                echo "Doris FE HTTP port not ready, waiting..."
                sleep 5
              done
              echo "Doris FE HTTP port is ready! Starting OTel Collector..."
      {{- end }}
      containers:
        - name: otel-collector
          image: "{{ .Values.otel.image.repository }}:{{ .Values.otel.image.tag }}"
          imagePullPolicy: {{ .Values.otel.image.pullPolicy }}
          command:
            - /otelcol-contrib
            - --config=/etc/otelcol/config.yaml
          ports:
            - name: otlp-grpc
              containerPort: {{ .Values.otel.ports.otlpGrpc }}
              protocol: TCP
            - name: otlp-http
              containerPort: {{ .Values.otel.ports.otlpHttp }}
              protocol: TCP
            - name: metrics
              containerPort: {{ .Values.otel.ports.metrics }}
              protocol: TCP
            - name: health-check
              containerPort: {{ .Values.otel.ports.healthCheck }}
              protocol: TCP
          env:
            # Pod identity for logging
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
          livenessProbe:
            httpGet:
              path: /
              port: {{ .Values.otel.ports.healthCheck }}
            initialDelaySeconds: 10
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /
              port: {{ .Values.otel.ports.healthCheck }}
            initialDelaySeconds: 5
            periodSeconds: 5
          resources:
            {{- toYaml .Values.otel.resources | nindent 12 }}
          volumeMounts:
            - name: config
              mountPath: /etc/otelcol
              readOnly: true
            {{- if .Values.otel.persistence.enabled }}
            - name: logs
              mountPath: {{ .Values.otel.persistence.logPath | default "/var/log/otelcol" }}
            {{- end }}
      volumes:
        - name: config
          configMap:
            name: {{ include "aiobs.otel.fullname" . }}-config
  {{- if .Values.otel.persistence.enabled }}
  # VolumeClaimTemplates for persistent log storage
  volumeClaimTemplates:
    - metadata:
        name: logs
        labels:
          {{- include "aiobs.labels" . | nindent 10 }}
          app.kubernetes.io/component: otel-collector
      spec:
        accessModes:
          - ReadWriteOnce
        {{- if .Values.otel.persistence.storageClass }}
        storageClassName: {{ .Values.otel.persistence.storageClass }}
        {{- end }}
        resources:
          requests:
            storage: {{ .Values.otel.persistence.size | default "10Gi" }}
  {{- end }}
{{- end }}
